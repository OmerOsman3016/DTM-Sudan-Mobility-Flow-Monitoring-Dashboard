<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <title>Sudan | Returnee & IDP Pathways</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CSV Parser -->
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

  <!-- CanvasFlowmapLayer -->
  <script src="./src/CanvasFlowmapLayer.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: #f5f6fa;
      color: #1e1e1e;
    }

    h1 {
      text-align: center;
      margin: 20px 0;
      font-size: 1.6rem;
      color: #003087;
    }

    .map-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
    }

    .map-container {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .map-title {
      text-align: center;
      background: #003087;
      color: #fff;
      font-size: 1rem;
      padding: 8px;
      margin: 0;
    }

    .map {
      width: 100%;
      height: 550px;
    }

    .legend {
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
      font-size: 13px;
      line-height: 1.5;
    }

    @media (max-width: 900px) {
      .map-grid {
        grid-template-columns: 1fr;
      }
      .map {
        height: 400px;
      }
    }
  </style>
</head>

<body>
  <h1>Sudan | Returnee and IDP Pathways</h1>

  <div class="map-grid">
    <div class="map-container">
      <h2 class="map-title">Returnee Pathways</h2>
      <div id="mapReturnees" class="map"></div>
    </div>
    <div class="map-container">
      <h2 class="map-title">IDP Pathways</h2>
      <div id="mapIDPs" class="map"></div>
    </div>
  </div>

  <script>
    // Shared base layer
    const mapboxURL =
      "https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q";

    const mapOptions = {
      attribution: '© Mapbox © OpenStreetMap',
      maxZoom: 18,
      tileSize: 512,
      zoomOffset: -1
    };

    const center = [16, 30];
    const zoom = 5.3;

    // Initialize both maps
    const mapR = L.map("mapReturnees").setView(center, zoom);
    const mapI = L.map("mapIDPs").setView(center, zoom);

    L.tileLayer(mapboxURL, mapOptions).addTo(mapR);
    L.tileLayer(mapboxURL, mapOptions).addTo(mapI);

    // ==== Returnee Pathways ====
    Papa.parse("./data/data.csv", {
      download: true,
      header: true,
      complete: (results) => {
        const features = results.data.map((d) => ({
          type: "Feature",
          geometry: { type: "Point", coordinates: [d.s_lon, d.s_lat] },
          properties: d,
        }));

        const layerR = L.canvasFlowmapLayer(
          { type: "FeatureCollection", features },
          {
            originAndDestinationFieldIds: {
              originUniqueIdField: "s_state_id",
              originGeometry: { x: "s_lon", y: "s_lat" },
              destinationUniqueIdField: "e_locality_id",
              destinationGeometry: { x: "e_lon", y: "e_lat" },
            },
            style: (f) => ({
              radius: 6,
              color: "#fff",
              fillColor: f.properties.isOrigin ? "#418FDE" : "#FF671F",
              fillOpacity: 0.8,
              weight: 1,
            }),
            canvasBezierStyle: {
              type: "classBreaks",
              field: "e_Volume",
              classBreakInfos: [
                { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: "#ffb81c", lineWidth: 1 } },
                { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: "#ff671f", lineWidth: 2 } },
                { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: "#d22630", lineWidth: 3 } },
              ],
            },
            pathDisplayMode: "all",
            animationStarted: true,
            animationDuration: 3000,
            onEachFeature: (f, layer) => {
              layer.bindTooltip(
                f.properties.isOrigin
                  ? `Origin: ${f.properties.s_State}`
                  : `Destination: ${f.properties.e_locality}`
              );
            },
          }
        ).addTo(mapR);
      },
    });

    // Legend for Returnees
    const legendR = L.control({ position: "bottomright" });
    legendR.onAdd = () => {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <strong>Returnee Flow Volume</strong><br>
        <div style="width:70px;height:3px;background:#ffb81c;margin:3px 5px 0 0;"></div>&lt; 10,000<br>
        <div style="width:70px;height:4px;background:#ff671f;margin:3px 5px 0 0;"></div>10,001–20,000<br>
        <div style="width:70px;height:6px;background:#d22630;margin:3px 5px 0 0;"></div>&gt; 20,000
      `;
      return div;
    };
    legendR.addTo(mapR);

    // ==== IDP Pathways ====
    Papa.parse("./data/data_idps.csv", {
      download: true,
      header: true,
      complete: (results) => {
        const features = results.data.map((d) => ({
          type: "Feature",
          geometry: { type: "Point", coordinates: [d.s_lon, d.s_lat] },
          properties: d,
        }));

        const layerI = L.canvasFlowmapLayer(
          { type: "FeatureCollection", features },
          {
            originAndDestinationFieldIds: {
              originUniqueIdField: "s_state_id",
              originGeometry: { x: "s_lon", y: "s_lat" },
              destinationUniqueIdField: "e_locality_id",
              destinationGeometry: { x: "e_lon", y: "e_lat" },
            },
            style: (f) => ({
              radius: 6,
              color: "#fff",
              fillColor: f.properties.isOrigin ? "#FF671F" : "#418FDE",
              fillOpacity: 0.8,
              weight: 1,
            }),
            canvasBezierStyle: {
              type: "classBreaks",
              field: "e_Volume",
              classBreakInfos: [
                { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: "#b3cde3", lineWidth: 1 } },
                { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: "#6497b1", lineWidth: 2 } },
                { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: "#005b96", lineWidth: 3 } },
              ],
            },
            pathDisplayMode: "all",
            animationStarted: true,
            animationDuration: 3000,
            onEachFeature: (f, layer) => {
              layer.bindTooltip(
                f.properties.isOrigin
                  ? `Origin: ${f.properties.s_State}`
                  : `Destination: ${f.properties.e_locality}`
              );
            },
          }
        ).addTo(mapI);
      },
    });

    // Legend for IDPs
    const legendI = L.control({ position: "bottomright" });
    legendI.onAdd = () => {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <strong>IDP Flow Volume</strong><br>
        <div style="width:70px;height:3px;background:#b3cde3;margin:3px 5px 0 0;"></div>&lt; 10,000<br>
        <div style="width:70px;height:4px;background:#6497b1;margin:3px 5px 0 0;"></div>10,001–20,000<br>
        <div style="width:70px;height:6px;background:#005b96;margin:3px 5px 0 0;"></div>&gt; 20,000
      `;
      return div;
    };
    legendI.addTo(mapI);
  </script>
</body>
</html>
