<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Keep all your existing head content -->
  <!-- ... -->
</head>
<body>

<div id="container">
  <h3>Sudan Returnee Movement Visualization</h3>
  <div class="subtitle">Flow of returnees between key locations (sample data)</div>
  <div id="loading">Loading map data...</div>
  <div id="error"></div>
  <svg id="map" width="960" height="600"></svg>
</div>

<script>
// Show loading state
d3.select("#loading").style("display", "block");
d3.select("#map").style("display", "none");

const svg = d3.select("#map"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

const projection = d3.geoMercator()
  .center([30, 15])  // Center Sudan
  .scale(1800)
  .translate([width / 2, height / 2]);

const path = d3.geoPath().projection(projection);

// Sample data
const flows = [
  { from: "Tine", to: "El Fasher", volume: 30000, date: "2023-05-01" },
  { from: "Gallabat", to: "Gedaref", volume: 25000, date: "2023-05-15" },
  { from: "Argeen", to: "Dongola", volume: 20000, date: "2023-06-01" },
  { from: "Kassala", to: "Kassala", volume: 15000, date: "2023-06-15" },
  { from: "Port Sudan", to: "Port Sudan", volume: 10000, date: "2023-07-01" }
];

const locations = {
  "Tine": [22.5, 14.0],
  "El Fasher": [25.4, 13.6],
  "Gallabat": [36.0, 12.0],
  "Gedaref": [35.4, 14.0],
  "Argeen": [30.0, 21.5],
  "Dongola": [30.5, 19.2],
  "Kassala": [36.4, 15.5],
  "Port Sudan": [37.2, 19.6]
};

// Create scales
const volumeScale = d3.scaleLinear()
  .domain([10000, 30000])
  .range([2, 10]);

const colorScale = d3.scaleSequential(d3.interpolateBlues)
  .domain([10000, 30000]);

// Create tooltip
const tooltip = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

// Arrow marker
svg.append("defs").append("marker")
  .attr("id", "arrow")
  .attr("viewBox", "0 -5 10 10")
  .attr("refX", 15)
  .attr("refY", 0)
  .attr("markerWidth", 6)
  .attr("markerHeight", 6)
  .attr("orient", "auto")
  .append("path")
  .attr("d", "M0,-5L10,0L0,5")
  .attr("fill", "#506489");

function drawMap(geoData) {
  try {
    // Clear loading state
    d3.select("#loading").style("display", "none");
    d3.select("#map").style("display", "block");
    
    // Draw Sudan map
    svg.append("g")
      .selectAll("path")
      .data(geoData.features)
      .enter().append("path")
      .attr("d", path)
      .attr("fill", "#e0e0e0")
      .attr("stroke", "#999")
      .attr("stroke-width", 0.5)
      .append("title")
      .text(d => d.properties.ADMIN1 || d.properties.name); // Updated to use ADMIN1 property

    // Rest of your drawMap function remains the same...
    // Plot flows
    const flowLines = svg.append("g")
      .selectAll("line")
      .data(flows)
      .enter().append("line")
      .attr("x1", d => projection(locations[d.from])[0])
      .attr("y1", d => projection(locations[d.from])[1])
      .attr("x2", d => projection(locations[d.to])[0])
      .attr("y2", d => projection(locations[d.to])[1])
      .attr("stroke", d => colorScale(d.volume))
      .attr("stroke-width", d => volumeScale(d.volume))
      .attr("marker-end", "url(#arrow)")
      .attr("class", "flow-line")
      .on("mouseover", function(event, d) {
        d3.select(this).attr("stroke-width", d => volumeScale(d.volume) + 2);
        tooltip.transition()
          .duration(200)
          .style("opacity", .9);
        tooltip.html(`
          <strong>From:</strong> ${d.from}<br>
          <strong>To:</strong> ${d.to}<br>
          <strong>Returnees:</strong> ${d.volume.toLocaleString()}<br>
          <strong>Date:</strong> ${d.date}
        `)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseout", function() {
        d3.select(this).attr("stroke-width", d => volumeScale(d.volume));
        tooltip.transition()
          .duration(500)
          .style("opacity", 0);
      });

    // Plot locations
    const locationPoints = svg.append("g")
      .selectAll("circle")
      .data(Object.keys(locations))
      .enter().append("circle")
      .attr("cx", d => projection(locations[d])[0])
      .attr("cy", d => projection(locations[d])[1])
      .attr("r", 4)
      .attr("fill", "#18375F")
      .on("mouseover", function(event, d) {
        d3.select(this).attr("r", 6);
        tooltip.transition()
          .duration(200)
          .style("opacity", .9);
        tooltip.html(`<strong>Location:</strong> ${d}`)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseout", function() {
        d3.select(this).attr("r", 4);
        tooltip.transition()
          .duration(500)
          .style("opacity", 0);
      });

    // Add location labels
    svg.append("g")
      .selectAll("text")
      .data(Object.keys(locations))
      .enter().append("text")
      .attr("x", d => projection(locations[d])[0] + 6)
      .attr("y", d => projection(locations[d])[1] - 6)
      .text(d => d)
      .attr("font-size", "10px")
      .attr("fill", "#333");

    // Add legend
    const legend = svg.append("g")
      .attr("transform", "translate(20,20)");

    const legendData = [10000, 20000, 30000];

    // Legend lines
    legend.selectAll("line")
      .data(legendData)
      .enter().append("line")
      .attr("x1", 0)
      .attr("x2", 30)
      .attr("y1", (d,i) => i * 20)
      .attr("y2", (d,i) => i * 20)
      .attr("stroke", d => colorScale(d))
      .attr("stroke-width", d => volumeScale(d));

    // Legend text
    legend.selectAll("text")
      .data(legendData)
      .enter().append("text")
      .attr("x", 40)
      .attr("y", (d,i) => i * 20 + 4)
      .text(d => d.toLocaleString() + " returnees")
      .attr("class", "legend-text");

    // Legend title
    legend.append("text")
      .attr("x", 0)
      .attr("y", -10)
      .text("Flow Volume")
      .attr("class", "legend-text")
      .attr("font-weight", "bold");

  } catch (e) {
    showError("Error drawing map: " + e.message);
  }
}

function showError(message) {
  d3.select("#loading").style("display", "none");
  d3.select("#error").style("display", "block").text(message);
  console.error(message);
}

// Load the ADMIN1.json file instead of using the hardcoded GeoJSON
d3.json("data/ADMIN1.json")
  .then(data => {
    drawMap(data);
  })
  .catch(error => {
    showError("Error loading map data: " + error);
    console.error("Error loading the GeoJSON file:", error);
  });
</script>

</body>
</html>
