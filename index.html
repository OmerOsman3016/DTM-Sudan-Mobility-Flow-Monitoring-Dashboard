<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix - Returnee & IDP Pathways" />
  <title>Sudan | Returnee & IDP Pathways</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      background: #f4f6f9;
      color: #1e1e1e;
    }

    h2 {
      text-align: center;
      margin: 10px 0;
      font-size: 1.3rem;
      color: #003087;
    }

    .map-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
    }

    .map-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      height: 600px;
      position: relative;
    }

    .map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }

    .legend {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      font-size: 13px;
      line-height: 1.4;
    }

    @media (max-width: 900px) {
      .map-grid {
        grid-template-columns: 1fr;
      }
      .map-container {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <h2>Returnee and IDP Pathways Across Sudan</h2>

  <div class="map-grid">
    <div class="map-container">
      <h2>Returnee Pathways</h2>
      <div id="mapReturnees" class="map"></div>
    </div>
    <div class="map-container">
      <h2>IDP Pathways</h2>
      <div id="mapIDPs" class="map"></div>
    </div>
  </div>

  <script>
    const commonStyle = {
      tileLayer: 'https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q',
      attribution: '© Mapbox © OpenStreetMap',
      zoom: 5.3,
      center: [16, 30]
    };

    // === Initialize Returnee Map ===
    const mapR = L.map('mapReturnees').setView(commonStyle.center, commonStyle.zoom);
    L.tileLayer(commonStyle.tileLayer, { attribution: commonStyle.attribution }).addTo(mapR);

    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      complete: (results) => {
        const geoJson = {
          type: 'FeatureCollection',
          features: results.data.map(d => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [d.s_lon, d.s_lat] },
            properties: d
          }))
        };

        const layerR = L.canvasFlowmapLayer(geoJson, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (f) => ({
            radius: 6,
            weight: 1,
            color: '#fff',
            fillColor: f.properties.isOrigin ? '#418FDE' : '#FF671F',
            fillOpacity: 0.8
          }),
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3 } }
            ]
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationDuration: 3000,
          onEachFeature: (f, layer) => {
            const info = f.properties.isOrigin ? `Origin: ${f.properties.s_State}` : `Destination: ${f.properties.e_locality}`;
            layer.bindTooltip(info);
          }
        }).addTo(mapR);
      }
    });

    // Legend for Returnees
    const legendR = L.control({ position: 'bottomright' });
    legendR.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <strong>Returnee Flow Volume</strong><br>
        <div style="width:70px;height:3px;background:#ffb81c;margin:5px 5px 0 0;"></div><span>&lt; 10,000</span><br>
        <div style="width:70px;height:4px;background:#ff671f;margin:5px 5px 0 0;"></div><span>10,001–20,000</span><br>
        <div style="width:70px;height:6px;background:#d22630;margin:5px 5px 0 0;"></div><span>&gt; 20,000</span>
      `;
      return div;
    };
    legendR.addTo(mapR);

    // === Initialize IDP Map ===
    const mapI = L.map('mapIDPs').setView(commonStyle.center, commonStyle.zoom);
    L.tileLayer(commonStyle.tileLayer, { attribution: commonStyle.attribution }).addTo(mapI);

    Papa.parse('./data/data_idps.csv', {
      download: true,
      header: true,
      complete: (results) => {
        const geoJson2 = {
          type: 'FeatureCollection',
          features: results.data.map(d => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [d.s_lon, d.s_lat] },
            properties: d
          }))
        };

        const layerI = L.canvasFlowmapLayer(geoJson2, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (f) => ({
            radius: 6,
            weight: 1,
            color: '#fff',
            fillColor: f.properties.isOrigin ? '#FF671F' : '#418FDE',
            fillOpacity: 0.8
          }),
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#b3cde3', lineWidth: 0.5 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#6497b1', lineWidth: 1.5 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#005b96', lineWidth: 3 } }
            ]
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationDuration: 3000,
          onEachFeature: (f, layer) => {
            const info = f.properties.isOrigin ? `Origin: ${f.properties.s_State}` : `Destination: ${f.properties.e_locality}`;
            layer.bindTooltip(info);
          }
        }).addTo(mapI);
      }
    });

    // Legend for IDPs
    const legendI = L.control({ position: 'bottomright' });
    legendI.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <strong>IDP Flow Volume</strong><br>
        <div style="width:70px;height:3px;background:#b3cde3;margin:5px 5px 0 0;"></div><span>&lt; 10,000</span><br>
        <div style="width:70px;height:4px;background:#6497b1;margin:5px 5px 0 0;"></div><span>10,001–20,000</span><br>
        <div style="width:70px;height:6px;background:#005b96;margin:5px 5px 0 0;"></div><span>&gt; 20,000</span>
      `;
      return div;
    };
    legendI.addTo(mapI);
  </script>
</body>
</html>
