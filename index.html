// Loading spinner functionality with new equalizer loader
document.addEventListener('DOMContentLoaded', function() {
  const loadingSpinner = document.getElementById('loading-spinner');
  const loadingText = document.querySelector('.loading-text');
  
  // Simulate loading for 3 seconds
  setTimeout(function() {
    loadingText.textContent = 'Almost there...';
    
    setTimeout(function() {
      loadingSpinner.style.opacity = '0';
      setTimeout(function() {
        loadingSpinner.style.display = 'none';
        document.body.style.animation = 'fadeIn 1.5s ease-in-out forwards';
      }, 500);
    }, 1000);
  }, 3000);

  // Initialize maps
  initializeMaps();
});

// Initialize both maps
function initializeMaps() {
  // Define Mapbox custom layers
  const mapboxCustom1 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
      attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      tileSize: 512,
      zoomOffset: -1,
      maxZoom: 18
  });

  const mapboxCustom2 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
      attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      tileSize: 512,
      zoomOffset: -1,
      maxZoom: 18
  });

  // Initialize the Returnee Pathways map
  const map = L.map('map').setView([16, 30], L.Browser.mobile ? 3 : 5.5);
  mapboxCustom1.addTo(map);

  // Initialize the IDP Pathways map
  const map2 = L.map('map2').setView([16, 30], L.Browser.mobile ? 3 : 5.5);
  mapboxCustom2.addTo(map2);

  // Load data and create flow maps
  loadReturneeMap(map);
  loadIDPMap(map2);
}

// Load and create Returnee Pathways map
function loadReturneeMap(map) {
  Papa.parse('./data/data.csv', {
    download: true,
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: (results) => {
      const geoJsonFeatureCollection = {
        type: 'FeatureCollection',
        features: results.data.map(datum => ({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
          properties: datum
        }))
      };

      const flowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
        originAndDestinationFieldIds: {
          originUniqueIdField: 's_state_id',
          originGeometry: { x: 's_lon', y: 's_lat' },
          destinationUniqueIdField: 'e_locality_id',
          destinationGeometry: { x: 'e_lon', y: 'e_lat' }
        },
        style: (feature) => {
          const baseRadius = 6;
          const maxRadius = 20;
          const volume = feature.properties.e_Volume || 0;

          const radius = feature.properties.isOrigin
            ? baseRadius
            : Math.min(baseRadius + (volume / 5000), maxRadius);

          return {
            radius: radius,
            weight: 1,
            color: feature.properties.isOrigin ? '#FFFFFF' : '#FFFFFF',
            fillColor: feature.properties.isOrigin ? '#418FDE' : 'rgb(255, 103, 31)',
            fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
          };
        },
        canvasBezierStyle: {
          type: 'classBreaks',
          field: 'e_Volume',
          classBreakInfos: [
            { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
            { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
            { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
          ],
          defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
        },
        pathDisplayMode: 'all',
        animationStarted: true,
        animationEasingFamily: 'Linear',
        animationEasingType: 'None',
        animationDuration: 3000,
        onEachFeature: addTooltip
      }).addTo(map);

      function addTooltip(feature, layer) {
        const tooltipContent = feature.properties.isOrigin
          ? `State of Displacement: ${feature.properties.s_State}`
          : `State of Return: ${feature.properties.e_locality}`;

        layer.bindTooltip(tooltipContent);
        layer.on('mouseover', () => layer.openTooltip());
        layer.on('mouseout', () => layer.closeTooltip());

        const popupContent = feature.properties.isOrigin
          ? `<b>State of Displacement:</b> ${feature.properties.s_State}`
          : `<b>State of Return:</b> ${feature.properties.e_locality}`;

        layer.bindPopup(popupContent);
      }

      flowmapLayer.on('mouseover', (e) => {
        if (e.sharedOriginFeatures.length) {
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        }
        if (e.sharedDestinationFeatures.length) {
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
        }
      });

      flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      
      // Add legend to the Returnee Pathways map
      addReturneeLegend(map);
    }
  });
}

// Load and create IDP Pathways map
function loadIDPMap(map2) {
  Papa.parse('./data/data_idps.csv', {
    download: true,
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: (results) => {
      const geoJsonFeatureCollection2 = {
        type: 'FeatureCollection',
        features: results.data.map(datum => ({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
          properties: datum
        }))
      };

      const flowmapLayer2 = L.canvasFlowmapLayer(geoJsonFeatureCollection2, {
        originAndDestinationFieldIds: {
          originUniqueIdField: 's_state_id',
          originGeometry: { x: 's_lon', y: 's_lat' },
          destinationUniqueIdField: 'e_locality_id',
          destinationGeometry: { x: 'e_lon', y: 'e_lat' }
        },
        style: (feature) => {
          const baseRadius = 12;
          const maxRadius = 12;
          const volume = feature.properties.e_Volume || 0;

          const radius = feature.properties.isOrigin
            ? baseRadius
            : Math.min(baseRadius + (volume / 5000), maxRadius);

          return {
            radius: radius,
            weight: 1,
            color: feature.properties.isOrigin ? '#FFFFFF' : '#FFFFFF',
            fillColor: feature.properties.isOrigin ? 'rgb(255, 103, 31)' : '#418FDE',
            fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
          };
        },
        canvasBezierStyle: {
          type: 'classBreaks',
          field: 'e_Volume',
          classBreakInfos: [
            { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
            { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
            { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
          ],
          defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
        },
        pathDisplayMode: 'all',
        animationStarted: true,
        animationEasingFamily: 'Linear',
        animationEasingType: 'None',
        animationDuration: 3000,
        onEachFeature: addTooltip
      }).addTo(map2);

      function addTooltip(feature, layer) {
        const tooltipContent = feature.properties.isOrigin
          ? `State of Displacement: ${feature.properties.s_State}`
          : `State of Return: ${feature.properties.e_locality}`;

        layer.bindTooltip(tooltipContent);
        layer.on('mouseover', () => layer.openTooltip());
        layer.on('mouseout', () => layer.closeTooltip());

        const popupContent = feature.properties.isOrigin
          ? `<b>Displacement From:</b> ${feature.properties.s_State}`
          : `<b>Displacement To:</b> ${feature.properties.e_locality}`;

        layer.bindPopup(popupContent);
      }

      flowmapLayer2.on('mouseover', (e) => {
        if (e.sharedOriginFeatures.length) {
          flowmapLayer2.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        }
        if (e.sharedDestinationFeatures.length) {
          flowmapLayer2.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
        }
      });

      flowmapLayer2.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      
      // Add legend to the IDP Pathways map
      addIDPLegend(map2);
    }
  });
}

// Add legend to the Returnee Pathways map
function addReturneeLegend(map) {
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = () => {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <span style="font-size:14px">Returnee Flow Volume:</span><br/>
      <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
      <span style="float:left;font-weight:bold"> < 10000</span><br/>
      <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
      <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
      <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
      <span style="float:left;font-weight:bold"> > 20,000</span><br/>
    `;
    return div;
  };
  legend.addTo(map);
}

// Add legend to the IDP Pathways map
function addIDPLegend(map2) {
  const legend2 = L.control({ position: 'bottomright' });
  legend2.onAdd = () => {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <span style="font-size:14px">IDP Flow Volume:</span><br/>
      <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
      <span style="float:left;font-weight:bold"> < 10000</span><br/>
      <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
      <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
      <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
      <span style="float:left;font-weight:bold"> > 20,000</span><br/>
    `;
    return div;
  };
  legend2.addTo(map2);
}
